"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTileData = getTileData;
exports.decodeTile = decodeTile;
exports.vectorTileFeatureToProp = vectorTileFeatureToProp;

var _pbf = _interopRequireDefault(require("pbf"));

var _vectorTile = require("@mapbox/vector-tile");

var _viewportMercatorProject = require("viewport-mercator-project");

// Copyright (c) 2020 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

/* global fetch */
var TILE_SIZE = 512;
var MAPBOX_HOST = 'https://a.tiles.mapbox.com';
var MAP_SOURCE = '/v4/mapbox.mapbox-streets-v7';

function getTileData(host, token, _ref) {
  var x = _ref.x,
      y = _ref.y,
      z = _ref.z;
  var mapSource = "".concat(host || MAPBOX_HOST).concat(MAP_SOURCE, "/").concat(z, "/").concat(x, "/").concat(y, ".vector.pbf?access_token=").concat(token);
  return fetch(mapSource).then(function (response) {
    return response.arrayBuffer();
  }).then(function (buffer) {
    return decodeTile(x, y, z, buffer);
  });
}

function decodeTile(x, y, z, arrayBuffer) {
  var tile = new _vectorTile.VectorTile(new _pbf["default"](arrayBuffer));
  var result = [];
  var xProj = x * TILE_SIZE;
  var yProj = y * TILE_SIZE;
  var scale = Math.pow(2, z);
  var projectFunc = project.bind(null, xProj, yProj, scale);
  /* eslint-disable guard-for-in */

  var layerName = 'building';
  var vectorTileLayer = tile.layers[layerName];

  if (!vectorTileLayer) {
    return [];
  }

  for (var i = 0; i < vectorTileLayer.length; i++) {
    var vectorTileFeature = vectorTileLayer.feature(i);
    var features = vectorTileFeatureToProp(vectorTileFeature, projectFunc);
    features.forEach(function (f) {
      f.properties.layer = layerName;

      if (f.properties.height) {
        result.push(f);
      }
    });
  }

  return result;
}

function project(x, y, scale, line, extent) {
  var sizeToPixel = extent / TILE_SIZE;

  for (var ii = 0; ii < line.length; ii++) {
    var p = line[ii]; // LNGLAT

    line[ii] = (0, _viewportMercatorProject.worldToLngLat)([x + p[0] / sizeToPixel, y + p[1] / sizeToPixel], scale);
  }
}
/* adapted from @mapbox/vector-tile/lib/vectortilefeature.js for better perf */

/* eslint-disable */


function vectorTileFeatureToProp(vectorTileFeature, project) {
  var coords = getCoordinates(vectorTileFeature);
  var type = _vectorTile.VectorTileFeature.types[vectorTileFeature.type];
  var extent = vectorTileFeature.extent;
  var i;
  var j;
  coords = classifyRings(coords);

  for (i = 0; i < coords.length; i++) {
    for (j = 0; j < coords[i].length; j++) {
      project(coords[i][j], extent);
    }
  }

  return coords.map(function (coordinates) {
    return {
      coordinates: coordinates,
      properties: vectorTileFeature.properties
    };
  });
}

function getCoordinates(vectorTileFeature) {
  var pbf = vectorTileFeature._pbf;
  pbf.pos = vectorTileFeature._geometry;
  var end = pbf.readVarint() + pbf.pos;
  var cmd = 1;
  var length = 0;
  var x = 0;
  var y = 0;
  var lines = [];
  var line;

  while (pbf.pos < end) {
    if (length <= 0) {
      var cmdLen = pbf.readVarint();
      cmd = cmdLen & 0x7;
      length = cmdLen >> 3;
    }

    length--;

    if (cmd === 1 || cmd === 2) {
      x += pbf.readSVarint();
      y += pbf.readSVarint();

      if (cmd === 1) {
        // moveTo
        if (line) lines.push(line);
        line = [];
      }

      line.push([x, y]);
    } else if (cmd === 7) {
      // Workaround for https://github.com/mapbox/mapnik-vector-tile/issues/90
      if (line) {
        line.push(line[0].slice()); // closePolygon
      }
    } else {
      throw new Error("unknown command ".concat(cmd));
    }
  }

  if (line) lines.push(line);
  return lines;
} // classifies an array of rings into polygons with outer rings and holes


function classifyRings(rings) {
  var len = rings.length;
  if (len <= 1) return [rings];
  var polygons = [];
  var polygon;
  var ccw;

  for (var i = 0; i < len; i++) {
    var area = signedArea(rings[i]);

    if (area === 0) {
      continue;
    }

    if (ccw === undefined) {
      ccw = area < 0;
    }

    if (ccw === area < 0) {
      if (polygon) {
        polygons.push(polygon);
      }

      polygon = [rings[i]];
    } else {
      polygon.push(rings[i]);
    }
  }

  if (polygon) {
    polygons.push(polygon);
  }

  return polygons;
}

function signedArea(ring) {
  var sum = 0;

  for (var i = 0, len = ring.length, j = len - 1, p1, p2; i < len; j = i++) {
    p1 = ring[i];
    p2 = ring[j];
    sum += (p2[0] - p1[0]) * (p1[1] + p2[1]);
  }

  return sum;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWNrZ2wtbGF5ZXJzLzNkLWJ1aWxkaW5nLWxheWVyLzNkLWJ1aWxkaW5nLXV0aWxzLmpzIl0sIm5hbWVzIjpbIlRJTEVfU0laRSIsIk1BUEJPWF9IT1NUIiwiTUFQX1NPVVJDRSIsImdldFRpbGVEYXRhIiwiaG9zdCIsInRva2VuIiwieCIsInkiLCJ6IiwibWFwU291cmNlIiwiZmV0Y2giLCJ0aGVuIiwicmVzcG9uc2UiLCJhcnJheUJ1ZmZlciIsImJ1ZmZlciIsImRlY29kZVRpbGUiLCJ0aWxlIiwiVmVjdG9yVGlsZSIsIlByb3RvYnVmIiwicmVzdWx0IiwieFByb2oiLCJ5UHJvaiIsInNjYWxlIiwiTWF0aCIsInBvdyIsInByb2plY3RGdW5jIiwicHJvamVjdCIsImJpbmQiLCJsYXllck5hbWUiLCJ2ZWN0b3JUaWxlTGF5ZXIiLCJsYXllcnMiLCJpIiwibGVuZ3RoIiwidmVjdG9yVGlsZUZlYXR1cmUiLCJmZWF0dXJlIiwiZmVhdHVyZXMiLCJ2ZWN0b3JUaWxlRmVhdHVyZVRvUHJvcCIsImZvckVhY2giLCJmIiwicHJvcGVydGllcyIsImxheWVyIiwiaGVpZ2h0IiwicHVzaCIsImxpbmUiLCJleHRlbnQiLCJzaXplVG9QaXhlbCIsImlpIiwicCIsImNvb3JkcyIsImdldENvb3JkaW5hdGVzIiwidHlwZSIsIlZlY3RvclRpbGVGZWF0dXJlIiwidHlwZXMiLCJqIiwiY2xhc3NpZnlSaW5ncyIsIm1hcCIsImNvb3JkaW5hdGVzIiwicGJmIiwiX3BiZiIsInBvcyIsIl9nZW9tZXRyeSIsImVuZCIsInJlYWRWYXJpbnQiLCJjbWQiLCJsaW5lcyIsImNtZExlbiIsInJlYWRTVmFyaW50Iiwic2xpY2UiLCJFcnJvciIsInJpbmdzIiwibGVuIiwicG9seWdvbnMiLCJwb2x5Z29uIiwiY2N3IiwiYXJlYSIsInNpZ25lZEFyZWEiLCJ1bmRlZmluZWQiLCJyaW5nIiwic3VtIiwicDEiLCJwMiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFv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dCAoYykgMjAyMCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCBQcm90b2J1ZiBmcm9tICdwYmYnO1xyXG5pbXBvcnQge1ZlY3RvclRpbGUsIFZlY3RvclRpbGVGZWF0dXJlfSBmcm9tICdAbWFwYm94L3ZlY3Rvci10aWxlJztcclxuaW1wb3J0IHt3b3JsZFRvTG5nTGF0fSBmcm9tICd2aWV3cG9ydC1tZXJjYXRvci1wcm9qZWN0JztcclxuXHJcbi8qIGdsb2JhbCBmZXRjaCAqL1xyXG5jb25zdCBUSUxFX1NJWkUgPSA1MTI7XHJcbmNvbnN0IE1BUEJPWF9IT1NUID0gJ2h0dHBzOi8vYS50aWxlcy5tYXBib3guY29tJztcclxuY29uc3QgTUFQX1NPVVJDRSA9ICcvdjQvbWFwYm94Lm1hcGJveC1zdHJlZXRzLXY3JztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRUaWxlRGF0YShob3N0LCB0b2tlbiwge3gsIHksIHp9KSB7XHJcbiAgY29uc3QgbWFwU291cmNlID0gYCR7aG9zdCB8fFxyXG4gICAgTUFQQk9YX0hPU1R9JHtNQVBfU09VUkNFfS8ke3p9LyR7eH0vJHt5fS52ZWN0b3IucGJmP2FjY2Vzc190b2tlbj0ke3Rva2VufWA7XHJcblxyXG4gIHJldHVybiBmZXRjaChtYXBTb3VyY2UpXHJcbiAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5hcnJheUJ1ZmZlcigpKVxyXG4gICAgLnRoZW4oYnVmZmVyID0+IGRlY29kZVRpbGUoeCwgeSwgeiwgYnVmZmVyKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVUaWxlKHgsIHksIHosIGFycmF5QnVmZmVyKSB7XHJcbiAgY29uc3QgdGlsZSA9IG5ldyBWZWN0b3JUaWxlKG5ldyBQcm90b2J1ZihhcnJheUJ1ZmZlcikpO1xyXG5cclxuICBjb25zdCByZXN1bHQgPSBbXTtcclxuICBjb25zdCB4UHJvaiA9IHggKiBUSUxFX1NJWkU7XHJcbiAgY29uc3QgeVByb2ogPSB5ICogVElMRV9TSVpFO1xyXG4gIGNvbnN0IHNjYWxlID0gTWF0aC5wb3coMiwgeik7XHJcblxyXG4gIGNvbnN0IHByb2plY3RGdW5jID0gcHJvamVjdC5iaW5kKG51bGwsIHhQcm9qLCB5UHJvaiwgc2NhbGUpO1xyXG5cclxuICAvKiBlc2xpbnQtZGlzYWJsZSBndWFyZC1mb3ItaW4gKi9cclxuICBjb25zdCBsYXllck5hbWUgPSAnYnVpbGRpbmcnO1xyXG4gIGNvbnN0IHZlY3RvclRpbGVMYXllciA9IHRpbGUubGF5ZXJzW2xheWVyTmFtZV07XHJcbiAgaWYgKCF2ZWN0b3JUaWxlTGF5ZXIpIHtcclxuICAgIHJldHVybiBbXTtcclxuICB9XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZWN0b3JUaWxlTGF5ZXIubGVuZ3RoOyBpKyspIHtcclxuICAgIGNvbnN0IHZlY3RvclRpbGVGZWF0dXJlID0gdmVjdG9yVGlsZUxheWVyLmZlYXR1cmUoaSk7XHJcbiAgICBjb25zdCBmZWF0dXJlcyA9IHZlY3RvclRpbGVGZWF0dXJlVG9Qcm9wKHZlY3RvclRpbGVGZWF0dXJlLCBwcm9qZWN0RnVuYyk7XHJcbiAgICBmZWF0dXJlcy5mb3JFYWNoKGYgPT4ge1xyXG4gICAgICBmLnByb3BlcnRpZXMubGF5ZXIgPSBsYXllck5hbWU7XHJcbiAgICAgIGlmIChmLnByb3BlcnRpZXMuaGVpZ2h0KSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goZik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBwcm9qZWN0KHgsIHksIHNjYWxlLCBsaW5lLCBleHRlbnQpIHtcclxuICBjb25zdCBzaXplVG9QaXhlbCA9IGV4dGVudCAvIFRJTEVfU0laRTtcclxuXHJcbiAgZm9yIChsZXQgaWkgPSAwOyBpaSA8IGxpbmUubGVuZ3RoOyBpaSsrKSB7XHJcbiAgICBjb25zdCBwID0gbGluZVtpaV07XHJcbiAgICAvLyBMTkdMQVRcclxuICAgIGxpbmVbaWldID0gd29ybGRUb0xuZ0xhdChbeCArIHBbMF0gLyBzaXplVG9QaXhlbCwgeSArIHBbMV0gLyBzaXplVG9QaXhlbF0sIHNjYWxlKTtcclxuICB9XHJcbn1cclxuXHJcbi8qIGFkYXB0ZWQgZnJvbSBAbWFwYm94L3ZlY3Rvci10aWxlL2xpYi92ZWN0b3J0aWxlZmVhdHVyZS5qcyBmb3IgYmV0dGVyIHBlcmYgKi9cclxuLyogZXNsaW50LWRpc2FibGUgKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHZlY3RvclRpbGVGZWF0dXJlVG9Qcm9wKHZlY3RvclRpbGVGZWF0dXJlLCBwcm9qZWN0KSB7XHJcbiAgbGV0IGNvb3JkcyA9IGdldENvb3JkaW5hdGVzKHZlY3RvclRpbGVGZWF0dXJlKTtcclxuICBjb25zdCB0eXBlID0gVmVjdG9yVGlsZUZlYXR1cmUudHlwZXNbdmVjdG9yVGlsZUZlYXR1cmUudHlwZV07XHJcbiAgY29uc3QgZXh0ZW50ID0gdmVjdG9yVGlsZUZlYXR1cmUuZXh0ZW50O1xyXG4gIGxldCBpO1xyXG4gIGxldCBqO1xyXG5cclxuICBjb29yZHMgPSBjbGFzc2lmeVJpbmdzKGNvb3Jkcyk7XHJcbiAgZm9yIChpID0gMDsgaSA8IGNvb3Jkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgZm9yIChqID0gMDsgaiA8IGNvb3Jkc1tpXS5sZW5ndGg7IGorKykge1xyXG4gICAgICBwcm9qZWN0KGNvb3Jkc1tpXVtqXSwgZXh0ZW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBjb29yZHMubWFwKGNvb3JkaW5hdGVzID0+ICh7XHJcbiAgICBjb29yZGluYXRlcyxcclxuICAgIHByb3BlcnRpZXM6IHZlY3RvclRpbGVGZWF0dXJlLnByb3BlcnRpZXNcclxuICB9KSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldENvb3JkaW5hdGVzKHZlY3RvclRpbGVGZWF0dXJlKSB7XHJcbiAgY29uc3QgcGJmID0gdmVjdG9yVGlsZUZlYXR1cmUuX3BiZjtcclxuICBwYmYucG9zID0gdmVjdG9yVGlsZUZlYXR1cmUuX2dlb21ldHJ5O1xyXG5cclxuICBjb25zdCBlbmQgPSBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcztcclxuICBsZXQgY21kID0gMTtcclxuICBsZXQgbGVuZ3RoID0gMDtcclxuICBsZXQgeCA9IDA7XHJcbiAgbGV0IHkgPSAwO1xyXG5cclxuICBjb25zdCBsaW5lcyA9IFtdO1xyXG4gIGxldCBsaW5lO1xyXG5cclxuICB3aGlsZSAocGJmLnBvcyA8IGVuZCkge1xyXG4gICAgaWYgKGxlbmd0aCA8PSAwKSB7XHJcbiAgICAgIGNvbnN0IGNtZExlbiA9IHBiZi5yZWFkVmFyaW50KCk7XHJcbiAgICAgIGNtZCA9IGNtZExlbiAmIDB4NztcclxuICAgICAgbGVuZ3RoID0gY21kTGVuID4+IDM7XHJcbiAgICB9XHJcblxyXG4gICAgbGVuZ3RoLS07XHJcblxyXG4gICAgaWYgKGNtZCA9PT0gMSB8fCBjbWQgPT09IDIpIHtcclxuICAgICAgeCArPSBwYmYucmVhZFNWYXJpbnQoKTtcclxuICAgICAgeSArPSBwYmYucmVhZFNWYXJpbnQoKTtcclxuXHJcbiAgICAgIGlmIChjbWQgPT09IDEpIHtcclxuICAgICAgICAvLyBtb3ZlVG9cclxuICAgICAgICBpZiAobGluZSkgbGluZXMucHVzaChsaW5lKTtcclxuICAgICAgICBsaW5lID0gW107XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxpbmUucHVzaChbeCwgeV0pO1xyXG4gICAgfSBlbHNlIGlmIChjbWQgPT09IDcpIHtcclxuICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL21hcGJveC9tYXBuaWstdmVjdG9yLXRpbGUvaXNzdWVzLzkwXHJcbiAgICAgIGlmIChsaW5lKSB7XHJcbiAgICAgICAgbGluZS5wdXNoKGxpbmVbMF0uc2xpY2UoKSk7IC8vIGNsb3NlUG9seWdvblxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gY29tbWFuZCAke2NtZH1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlmIChsaW5lKSBsaW5lcy5wdXNoKGxpbmUpO1xyXG5cclxuICByZXR1cm4gbGluZXM7XHJcbn1cclxuXHJcbi8vIGNsYXNzaWZpZXMgYW4gYXJyYXkgb2YgcmluZ3MgaW50byBwb2x5Z29ucyB3aXRoIG91dGVyIHJpbmdzIGFuZCBob2xlc1xyXG5cclxuZnVuY3Rpb24gY2xhc3NpZnlSaW5ncyhyaW5ncykge1xyXG4gIGNvbnN0IGxlbiA9IHJpbmdzLmxlbmd0aDtcclxuXHJcbiAgaWYgKGxlbiA8PSAxKSByZXR1cm4gW3JpbmdzXTtcclxuXHJcbiAgY29uc3QgcG9seWdvbnMgPSBbXTtcclxuICBsZXQgcG9seWdvbjtcclxuICBsZXQgY2N3O1xyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICBjb25zdCBhcmVhID0gc2lnbmVkQXJlYShyaW5nc1tpXSk7XHJcbiAgICBpZiAoYXJlYSA9PT0gMCkge1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2N3ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgY2N3ID0gYXJlYSA8IDA7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNjdyA9PT0gYXJlYSA8IDApIHtcclxuICAgICAgaWYgKHBvbHlnb24pIHtcclxuICAgICAgICBwb2x5Z29ucy5wdXNoKHBvbHlnb24pO1xyXG4gICAgICB9XHJcbiAgICAgIHBvbHlnb24gPSBbcmluZ3NbaV1dO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcG9seWdvbi5wdXNoKHJpbmdzW2ldKTtcclxuICAgIH1cclxuICB9XHJcbiAgaWYgKHBvbHlnb24pIHtcclxuICAgIHBvbHlnb25zLnB1c2gocG9seWdvbik7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcG9seWdvbnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNpZ25lZEFyZWEocmluZykge1xyXG4gIGxldCBzdW0gPSAwO1xyXG4gIGZvciAobGV0IGkgPSAwLCBsZW4gPSByaW5nLmxlbmd0aCwgaiA9IGxlbiAtIDEsIHAxLCBwMjsgaSA8IGxlbjsgaiA9IGkrKykge1xyXG4gICAgcDEgPSByaW5nW2ldO1xyXG4gICAgcDIgPSByaW5nW2pdO1xyXG4gICAgc3VtICs9IChwMlswXSAtIHAxWzBdKSAqIChwMVsxXSArIHAyWzFdKTtcclxuICB9XHJcbiAgcmV0dXJuIHN1bTtcclxufVxyXG4iXX0=